<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>AI 图片预测</title>
        <link rel="stylesheet" type="text/css" href="css/open-iconic-bootstrap.css">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <link rel="stylesheet" type="text/css" href="css/cauchy/main.css">
        <style>
            .boxsizingBorder {
                -webkit-box-sizing: border-box;
                   -moz-box-sizing: border-box;
                        box-sizing: border-box;
            }

            .wrapper {
                padding: 10px;
                margin: 5px 0;
                background-color: #0f9d58;
            }

            textarea {
                font-size: 20px;
                width: 100%;
                height: 100%;
            }
        </style>
        <script src="js/jquery.min.js" type="text/javascript"></script>
        <script src="js/jquery.cookie.js" type="text/javascript"></script>
        <script src="js/jquery.form.js" type="text/javascript"></script>
        <script>
            const urlParams = new URLSearchParams(window.location.search);
            window.onload = function() {
                if (urlParams.has("default")) {
                    $("#result").text("data:image/jpeg;base64," + urlParams.get("default"));
                    $("#img_area").html('<div class="sitetip">目标图片:</div><img src="data:image/jpeg;base64,'+urlParams.get("default")+'" alt=""/>');
                }
                var input = document.getElementById("file_input");
                if (typeof(FileReader) === 'undefined') {
                    $("#result").text("抱歉，你的浏览器不支持 FileReader，请使用现代浏览器操作！");
                    input.setAttribute('disabled','disabled');
                } else {
                    input.addEventListener('change', readFile, false);
                }
            }
            function readFile() {
                var file = this.files[0];
                //这里我们判断下类型如果不是图片就返回 去掉就可以上传任意文件
                if (!/image\/\w+/.test(file.type)) {
                    alert("请确保文件为图像类型");
                    return false;
                }
                var reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(e) {
                    $("#result").text(this.result);
                    $("#img_area").html('<div class="sitetip">目标图片:</div><img src="'+this.result+'" alt=""/>');
                }
            }
            function onDetectFace() {
                if (urlParams.has("flask")) {
                    let host = "116.85.54.39";
                    let port = "8189";
                    if (urlParams.has("host")) {
                        host = urlParams.get("host");
                    }
                    if (urlParams.has("port")) {
                        port = urlParams.get("port");
                    }
                    let jsonData = {"msgtype": "facedet", "host": host, "port": parseInt(port), "orig_img": $("#result").val()};
                    msgData = JSON.stringify(jsonData, undefined, 4);
                    $.post(urlParams.get("flask"), msgData, function(response) {
                        if (response.hasOwnProperty("predict")) {
                            $("#img_area").html('<div>探测结果:</div><img src="data:image/jpeg;base64,' + response["predict"] + '" alt=""/>');
                            $("#result").text('data:image/jpeg;base64,' + respnse["predict"]);
                        } else if (response.hasOwnProperty("error")) {
                            $("#img_area").html('<div>执行错误:' + response["error"] + '</div>');
                        } else {
                            $("#img_area").html('<div>执行错误:内部错误</div>');
                        }
                    }, "json");
                }
            }
        </script>
    </head>
    <body>
        <input type="file" value="image" id="file_input" />
        <button onclick="onDetectFace()">脸部探测</button>
        <p id="img_area"></p>
        <textarea name="img" id="result" rows=30 cols=200></textarea>
    </body>
</html>
