<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/codemirror.min.css">
    <link rel="stylesheet" href="css/monokai.min.css">
    <link rel="stylesheet" href="css/idea.min.css">
    <script src="js/jquery.min.js" type="text/javascript"></script>
    <script src="js/codemirror.min.js"></script>
    <script src="js/python.min.js"></script>
    <style>
        .CodeMirror{
          border: 2px solid #0f9d58;
          margin: 8px 0;
          font-size: 16px;
          width: 100%;
          height: 100%;
        }
    </style>
</head>
<body>
    <span><b>Python Code:</b></span>
    <textarea id="code" name="code"></textarea>
    <br>
    <button onclick="run()">运行</button> <button onclick="stop()">停止</button>
    <br>
    <br>
    <span><b>Console Log:</b></span>
    <textarea id="logger" name="logger"></textarea>
    <br>
    <span><b>Error Log:</b></span>
    <textarea id="errorinfo" name="errorinfo"></textarea>
    <br>
    <span><b>Image Show:</b></span>
    <br>
    <img id="imshow" src="data:image/jpg;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAAAAABXZoBIAAABs0lEQVR4nL2SPWhTYRSGn+98P/fe/N0kkNpKIYs4WCEOgrMuioiCOHcQF8VREDdBdHNwcg2dXAqi4OagFOzi4qYOKgQCaQVrLNcmtzkOuaGm7r7TgYeX8/MeKBRhBQSgTFEcqBlYBvEOEj+PiACsgBMakB7CSRM8WAvmEKIKCWIT8OWHd+dZhUtVAgB+SXcr83RFnxMTwNPQfJ4tvMl6kBLjXEfV/YUcj7NnV6ZLVuxt7c9gQIQHn36dFMCBKX3Rt9N5LTQw7b4+JapjOALVDd2e+mpE3rCm79sAJgHS7d+vp07BYW9q/wR1TIoPsJ7vXSxaluCGDu5JRAUEysnnwdeIwlnvjLXbjiE2nOmsnl3P9GN3usOk+uOF+/DyaOvqtY3VnWY+KpFPsl27D0Aa9yaTHdWBap5vvnq3OdJbvjikwJ2+6vfBo/vX24s1OKdbSwepBI4vnF4+hnWA9V39RlSeQQsQIQGpEGwve2KL7IkgSIIJxA5T49RAV1qFTfaojyaZlTF7Saw/IR0tbvnIAUg5ZJQk2ddEhwKtYRhelvEkn7V0BrF4byDAhfNYJ/980f/SH4VcezibkiyPAAAAAElFTkSuQmCC"/>
    <script>
        const user = "16601548608";
        const uuid = "123456";
        const appId = "k12pyr." + user + "." + uuid;
        const urlParams = new URLSearchParams(window.location.search);
        const defcode = urlParams.get('default');

        var tokenId = null;
        var gtimeId = null;
        var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
            mode : "python",
            theme: "monokai",
            indentUnit : 4,
            smartIndent : true,
            tabSize: 4,
            readOnly : false,
            showCursorWhenSelecting : true,
            styleActiveLine: true,
            matchBrackets: true,
            autofocus: true,
            lineWrapping: true,
            lineNumbers: true,
        });

        editor.setSize('auto','400px');
        editor.setOption("extraKeys", {
            "Ctrl-Space": "autocomplete",
            "Ctrl-S": function() {console.log("save");},
            // Tab to 4 spaces
            Tab: function(cm) {
                var spaces = Array(cm.getOption("indentUnit") + 1).join(" ");
                cm.replaceSelection(spaces);
            }});

        if (defcode != undefined) {
            editor.setValue(defcode)
        } else {
            editor.setValue("print('Hello World!')")
        }

        var logger = CodeMirror.fromTextArea(document.getElementById("logger"), {
            mode: "text/plain",
            theme: "idea",
            readOnly : true,
            showCursorWhenSelecting : true,
            lineWrapping: true,
            lineNumbers : false
        });
        logger.setSize('auto','300px');

        var errorinfo = CodeMirror.fromTextArea(document.getElementById("errorinfo"), {
            mode: "application/json",
            indentUnit: 4,
            smartIndent: true,
            theme: "idea",
            readOnly : true,
            showCursorWhenSelecting : true,
            lineWrapping: true,
            lineNumbers : false
        });
        errorinfo.setSize('auto','300px');

        function message_pop() {
            // console.log("call pop")
            $.get("http://116.85.5.40:8119/k12ai/private/popmsg?key=" + appId + ".runlog",
                  function(response) {
                      if (gtimeId != null) {
                          clearTimeout(gtimeId);
                          gtimeId = null;
                      }
                      var data = $.parseJSON(response);
                      // console.log(data)
                      for (it of data) {
                          var jsondata = $.parseJSON(it)
                          if (jsondata['token'] != tokenId) {
                              continue
                          }
                          var jdata = jsondata["data"]
                          if (jdata.hasOwnProperty("log")) {
                              logger.replaceRange(jdata["log"], CodeMirror.Pos(logger.lastLine()));
                              // logger.focus();
                              // logger.setCursor(logger.lineCount(), 0);
                          } else if (jdata.hasOwnProperty("imshow")) {
                              imgelem = document.getElementById("imshow");
                              imgelem.src = "data:image/jpg;base64," + jdata["imshow"];
                          } else {
                              logger.setValue("message format error (html)!")
                              return
                          }
                      }
                      if (data.length == 0) {
                          $.get("http://116.85.5.40:8119/k12ai/private/popmsg?key=" + appId + ".error", function(err) {
                              var errdata = $.parseJSON(err);
                              for (it of errdata) {
                                  var jsondata = $.parseJSON(it)
                                  if (jsondata['token'] != tokenId) {
                                      continue
                                  }
                                  var jdata = jsondata["data"]
                                  // console.log(jdata)
                                  if (jdata["expand"].hasOwnProperty("status")) {
                                      switch (jdata["expand"]["status"]) {
                                          case "starting":
                                              logger.setValue("starting...." + "\n\n");
                                              break;
                                          case "running":
                                              errorinfo.setValue("");
                                              logger.replaceRange("running..." + "\n\n", CodeMirror.Pos(logger.lastLine()));
                                              break;
                                          case "finished":
                                              logger.replaceRange("finished..." + "\n\n", CodeMirror.Pos(logger.lastLine()));
                                              if (gtimeId != null) {
                                                  clearTimeout(gtimeId);
                                                  gtimeId = null;
                                              }
                                              return
                                      }
                                  } else {
                                      if (jdata["code"] > 100200) {
                                          var jerr = JSON.stringify(jdata, null, 4)
                                          errorinfo.replaceRange(jerr, CodeMirror.Pos(logger.lastLine()));
                                          return
                                      }
                                  }
                              }
                          })
                          gtimeId = setTimeout("message_pop()", 1000);
                      } else {
                          message_pop();  // call self
                      }
                  }).fail(function () {
                      console.log('restapi call fail, check network connnet.');
                      if (gtimeId != null) {
                          clearTimeout(gtimeId);
                          gtimeId = null;
                      }
                      gtimeId = setTimeout("message_pop()", 5000);
                  });
        }

        function run() {
            if (tokenId == null) {
                tokenId = (100001 + Math.ceil(Math.random()*100000)).toString()
            }
            if (gtimeId != null) {
                clearTimeout(gtimeId);
                gtimeId = null;
            }
            var data = editor.getValue();
            var params = {
                "appId": appId,
                "token": tokenId,
                "op": "runcode.start",
                "user": user,
                "service_name": "k12pyr",
                "service_uuid": uuid,
                "service_params": {
                    "code": data,
                    "devoloper": true
                }
            };
            $.post("http://116.85.5.40:8119/k12ai/framework/execute",
                   JSON.stringify(params), function(response) {
                      imgelem = document.getElementById("imshow");
                      imgelem.src = "";
                       switch (response['code']) {
                           case 100000:
                               logger.setValue(JSON.stringify(response) + "\n\n");
                               gtimeId = setTimeout("message_pop()", 1000);
                               break;
                           case 100204:
                               logger.replaceRange(JSON.stringify(response) + "\n\n", CodeMirror.Pos(logger.lastLine()));
                               gtimeId = setTimeout("message_pop()", 100);
                               break;
                           default:
                               logger.replaceRange(JSON.stringify(response) + "\n\n", CodeMirror.Pos(logger.lastLine()));
                       }
                       logger.focus();
                   }, "json");
        }

        function stop() {
            if (gtimeId != null) {
                clearTimeout(gtimeId);
                gtimeId = null;
            }
            var data = editor.getValue();
            var params = {
                "appId": appId,
                "token": tokenId,
                "op": "runcode.stop",
                "user": user,
                "service_name": "k12pyr",
                "service_uuid": uuid
            };
            $.post("http://116.85.5.40:8119/k12ai/framework/execute",
                   JSON.stringify(params), function(response){
                   }, "json");
        };
    </script>
</body>
</html>
