<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/codemirror.min.css">
    <link rel="stylesheet" href="css/monokai.min.css">
    <link rel="stylesheet" href="css/idea.min.css">
    <script src="js/jquery.min.js" type="text/javascript"></script>
    <script src="js/codemirror.min.js"></script>
    <script src="js/python.min.js"></script>
</head>
<body>
    <span><b>Python Code:</b></span>
    <textarea id="code" name="code"></textarea>
    <br>
    <button onclick="run()">运行</button>
    <br>
    <br>
    <span><b>Console Log:</b></span>
    <textarea id="logger" name="logger"></textarea>
    <script>
        var intervalId = null;
        var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
            mode : "python",
            theme: 'monokai',
            indentUnit : 4,
            smartIndent : true,
            tabSize : 4,
            readOnly : false,
            showCursorWhenSelecting : true,
            styleActiveLine: true,
            matchBrackets: true,
            lineWrapping: true,
            lineNumbers : true
        });

        editor.setSize('auto','400px');
        editor.setOption("extraKeys", {
        // Tab键换成4个空格
        Tab: function(cm) {
            var spaces = Array(cm.getOption("indentUnit") + 1).join(" ");
            cm.replaceSelection(spaces);
        }});
        editor.setValue("print('Hello World!')")

        var logger = CodeMirror.fromTextArea(document.getElementById("logger"), {
            theme: 'idea',
            readOnly : true,
            showCursorWhenSelecting : true,
            lineWrapping: false,
            lineNumbers : false
        });
        logger.setSize('auto','300px');

        function message_pop() {
            $.get("http://116.85.5.40:8119/k12ai/private/popmsg?key=talentai.console",
                  function(data) {
                      if (data != '') {
                          jsondata = $.parseJSON(data)
                          if (!jsondata.hasOwnProperty('data')) {
                              return
                          }
                          jsondata = jsondata['data']
                          if (jsondata.hasOwnProperty('status')) {
                              state = jsondata['status']
                              if (state != 'running') {
                                    clearInterval(intervalId)
                              }
                          }
                          if (jsondata.hasOwnProperty('log')) {
                              console.log(jsondata)
                              logger.setValue(logger.getValue() + jsondata['log'])
                          }
                      }
                  });
        }

        function run() {
            if (intervalId != null) {
                clearInterval(intervalId)
            }
            
            var data = editor.getValue();
            var params = {
                "token": "123456",
                "op": "runcode.start",
                "user": "16601548608",
                "service_name": "k12pyr",
                "service_uuid": "123456",
                "service_params": {
                    "code": editor.getValue(),
                    "_k12.tb_logdir": "/data/tmp"
                }
            }
            $.post("http://116.85.5.40:8119/k12ai/framework/execute",
                   JSON.stringify(params), function(response){
                   }, "json");
            logger.setValue("")
            intervalId = setInterval("message_pop()", 3000)
        };
    </script>
</body>
</html>
