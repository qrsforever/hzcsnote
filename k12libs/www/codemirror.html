<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/codemirror.min.css">
    <link rel="stylesheet" href="css/monokai.min.css">
    <link rel="stylesheet" href="css/idea.min.css">
    <script src="js/jquery.min.js" type="text/javascript"></script>
    <script src="js/codemirror.min.js"></script>
    <script src="js/python.min.js"></script>
    <style>
        .CodeMirror{
          border: 2px solid #0f9d58;
          margin: 8px 0; 
          font-size: 16px;
          width: 100%;
          height: 100%;
        }
    </style>
</head>
<body>
    <span><b>Python Code:</b></span>
    <textarea id="code" name="code"></textarea>
    <br>
    <button onclick="run()">运行</button> <button onclick="stop()">停止</button>
    <br>
    <br>
    <span><b>Console Log:</b></span>
    <textarea id="logger" name="logger"></textarea>
    <script>
        const user = "16601548608";
        const uuid = "123456";
        const appId = "k12pyr." + user + "." + uuid;
        const urlParams = new URLSearchParams(window.location.search);
        const defcode = urlParams.get('default');

        var tokenId = null;
        var gtimeId = null;
        var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
            mode : "python",
            theme: "monokai",
            indentUnit : 4,
            smartIndent : true,
            tabSize : 4,
            readOnly : false,
            showCursorWhenSelecting : true,
            styleActiveLine: true,
            matchBrackets: true,
            autofocus: true,
            lineWrapping: true,
            lineNumbers : true
        });

        editor.setSize('auto','600px');
        editor.setOption("extraKeys", {
            "Ctrl-Space": "autocomplete",
            "Ctrl-S": function() {console.log("save");},
            // Tab to 4 spaces
            Tab: function(cm) {
                var spaces = Array(cm.getOption("indentUnit") + 1).join(" ");
                cm.replaceSelection(spaces);
            }});

        if (defcode != undefined) {
            editor.setValue(defcode)
        } else {
            editor.setValue("print('Hello World!')")
        }

        var logger = CodeMirror.fromTextArea(document.getElementById("logger"), {
            mode : "text/plain",
            theme: "idea",
            readOnly : true,
            showCursorWhenSelecting : true,
            lineWrapping: true,
            lineNumbers : false
        });
        logger.setSize('auto','600px');

        function message_pop() {
            // console.log("call pop")
            $.get("http://116.85.5.40:8119/k12ai/private/popmsg?key=" + appId + ".runlog",
                  function(response) {
                      if (gtimeId != null) {
                          clearTimeout(gtimeId);
                          gtimeId = null;
                      }
                      var data = $.parseJSON(response);
                      for (it of data) {
                          jsondata = $.parseJSON(it)
                          if (jsondata['token'] != tokenId) {
                              continue
                          }
                          if (jsondata["data"].hasOwnProperty("expand")) {
                              var logdata = jsondata["data"]["expand"];
                              if (logdata.hasOwnProperty("log")) {
                                  logger.replaceRange(logdata["log"], CodeMirror.Pos(logger.lastLine()));
                                  // logger.focus();
                                  // logger.setCursor(logger.lineCount(), 0);
                              }
                              if (logdata.hasOwnProperty('status')) {
                                  state = logdata['status'];
                                  if (state == "finished") {
                                      return;
                                  }
                              }
                          } else {
                              logger.setValue("message format error!")
                              return
                          }
                      }
                      if (data.length == 0) {
                          gtimeId = setTimeout("message_pop()", 1000);
                      } else {
                          message_pop();  // call self
                      }
                  }).fail(function () {
                      console.log('restapi call fail, check network connnet.');
                      if (gtimeId != null) {
                          clearTimeout(gtimeId);
                          gtimeId = null;
                      }
                      gtimeId = setTimeout("message_pop()", 5000);
                  });
        }

        function run() {
            if (tokenId == null) {
                tokenId = (100001 + Math.ceil(Math.random()*100000)).toString()
            }
            if (gtimeId != null) {
                clearTimeout(gtimeId);
                gtimeId = null;
            }
            var data = editor.getValue();
            var params = {
                "appId": appId,
                "token": tokenId,
                "op": "runcode.start",
                "user": user,
                "service_name": "k12pyr",
                "service_uuid": uuid,
                "service_params": {
                    "code": data,
                    "devoloper": true
                }
            };
            $.post("http://116.85.5.40:8119/k12ai/framework/execute",
                   JSON.stringify(params), function(response){
                       switch (response['code']) {
                           case 100000:
                               logger.setValue(JSON.stringify(response) + "\n\n");
                               gtimeId = setTimeout("message_pop()", 1000);
                               break;
                           case 100204:
                               logger.replaceRange(JSON.stringify(response) + "\n\n", CodeMirror.Pos(logger.lastLine()));
                               gtimeId = setTimeout("message_pop()", 100);
                               break;
                           default:
                               logger.replaceRange(JSON.stringify(response) + "\n\n", CodeMirror.Pos(logger.lastLine()));
                       }
                       logger.focus();
                   }, "json");
        }

        function stop() {
            if (gtimeId != null) {
                clearTimeout(gtimeId);
                gtimeId = null;
            }
            var data = editor.getValue();
            var params = {
                "appId": appId,
                "token": tokenId,
                "op": "runcode.stop",
                "user": user,
                "service_name": "k12pyr",
                "service_uuid": uuid
            };
            $.post("http://116.85.5.40:8119/k12ai/framework/execute",
                   JSON.stringify(params), function(response){
                   }, "json");
        };
    </script>
</body>
</html>
